# ==============================================================================
# BUILD_TOPOLOGY.toml - Build Topology Metadata for TheRock
# ==============================================================================
#
# This file is the single source of truth for TheRock's build artifact structure.
# It serves three primary purposes:
#
#   1. CMake Feature Generation: At configure time, topology_to_cmake.py reads
#      this file and generates therock_add_feature() calls for each artifact,
#      creating the THEROCK_ENABLE_* cache variables that control the build.
#
#   2. CI/CD Pipeline Sharding: The build_topology.py module parses this file
#      to compute artifact dependencies for sharded builds, determining which
#      artifacts need to be fetched from artifact storage before each stage.
#
#   3. Partial Source Checkouts: Source sets define which git submodules are
#      needed for each artifact group, enabling CI jobs to clone only the
#      submodules required for their build stage (via fetch_sources.py --stage).
#
# HIERARCHY:
#   - Source Sets    - Groupings of git submodules for partial checkouts
#   - Build Stages   - CI/CD pipeline jobs that build sets of artifact groups
#   - Artifact Groups - Logical groupings of related artifacts with shared deps
#   - Artifacts      - Individual build outputs (the fundamental packaging unit)
#
# NAMING CONVENTIONS:
#   - Entity names (stages, groups, artifacts): lowercase with hyphens (e.g., "core-runtime")
#   - feature_name: UPPERCASE with underscores (e.g., "CORE_RUNTIME") - maps to THEROCK_ENABLE_*
#   - feature_group: UPPERCASE with underscores (e.g., "CORE") - maps to group options
#   - type values: lowercase (e.g., "generic", "per-arch", "target-neutral", "target-specific")
#   - platform values: lowercase (e.g., "windows", "linux")
#
# SCHEMA REFERENCE:
#
#   [source_sets.<name>]
#   description = "Human-readable description"
#   submodules = ["submodule1", "submodule2"]  # Git submodule directory names
#
#   [build_stages.<name>]
#   description = "Human-readable description"
#   artifact_groups = ["group1", "group2"]  # Groups built in this stage
#   type = "generic" | "per-arch"           # Optional, default "generic"
#
#   [artifact_groups.<name>]
#   description = "Human-readable description"
#   type = "generic" | "per-arch"           # "per-arch" = built per GPU architecture
#   artifact_group_deps = ["dep1", "dep2"]  # Optional, other groups this depends on
#   source_sets = ["set1", "set2"]          # Optional, source sets needed for this group
#
#   [artifacts.<name>]
#   artifact_group = "group-name"           # Required: which group this belongs to
#   type = "target-neutral" | "target-specific"  # target-specific = per GPU arch
#   artifact_deps = ["dep1", "dep2"]        # Optional: other artifacts this depends on
#   feature_name = "FEATURE_NAME"           # Optional: override auto-generated name
#   feature_group = "GROUP_NAME"            # Optional: override auto-generated group
#   platform = "windows"                    # Optional: platform-specific artifact
#   disable_platforms = ["windows"]         # Optional: platforms where disabled
#
# ==============================================================================

[metadata]
version = "1.0"
description = "TheRock artifact-based build topology"

# ==============================================================================
# SOURCE SETS - Submodule groupings for partial checkouts
# ==============================================================================
# Each source_set defines submodules needed for a category of builds.
# Currently just lists submodules; can be extended later with sparse_checkout specs.
# Names are chosen to align with fetch_sources.py flags where possible.

[source_sets.base]
description = "Base infrastructure submodules"
submodules = ["half", "rocm-cmake", "amdsmi"]

[source_sets.compilers]
description = "Compiler toolchain submodules"
submodules = ["llvm-project", "HIPIFY", "spirv-llvm-translator"]

[source_sets.rocm-systems]
description = "ROCm systems monorepo (runtime, profiler, etc.)"
submodules = ["rocm-systems"]

[source_sets.rocm-libraries]
description = "ROCm libraries monorepo (math libs)"
submodules = ["rocm-libraries"]

[source_sets.ml-frameworks]
description = "ML framework submodules"
submodules = ["composable_kernel"]

[source_sets.comm-libs]
description = "Communication library submodules"
submodules = ["rccl", "rccl-tests"]

[source_sets.profiler-extras]
description = "Additional profiler submodules"
submodules = ["rocprof-trace-decoder"]

# ==============================================================================
# BUILD STAGES - Pipeline jobs that build sets of artifact groups
# ==============================================================================
# These represent actual CI/CD pipeline jobs optimized for parallel execution
# Note: Stage names are identifiers, not sequence indicators - many can run in parallel

[build_stages.foundation]
description = "Foundation - critical path dependencies"
artifact_groups = ["third-party-sysdeps", "base"]

[build_stages.compiler-runtime]
description = "Compiler, runtimes, and core profiling"
artifact_groups = [
    "compiler",
    "core-runtime",
    "third-party-libs",
    "hip-runtime",
    "opencl-runtime",
    "profiler-core"
]

[build_stages.math-libs]
description = "Math and ML libraries per architecture"
artifact_groups = ["math-libs", "ml-libs"]
type = "per-arch"

[build_stages.comm-libs]
description = "Communication libraries per architecture (can run parallel to math-libs)"
artifact_groups = ["comm-libs"]
type = "per-arch"

[build_stages.dctools-core]
description = "Data center tools with minimal dependencies"
artifact_groups = ["dctools-core"]

# Future stages
# [build_stages.dctools-rocm]
# description = "Data center tools that depend on ROCm libraries"
# artifact_groups = ["dctools-rocm"]
# depends_on = ["math-libs"]  # Will need math/ML libraries

# [build_stages.iree-libs]
# description = "IREE and Fusilli integration (parallel to compiler-runtime)"
# artifact_groups = ["iree-libs"]

[build_stages.profiler-apps]
description = "Profiler applications (depends on profiler-core)"
artifact_groups = ["profiler-apps"]

# ==============================================================================
# ARTIFACT GROUPS - Logical groupings of related artifacts
# ==============================================================================
# These define build dependencies and source requirements

[artifact_groups.third-party-sysdeps]
description = "Critical system dependencies (always needed)"
type = "generic"
source_sets = []  # No submodules - uses vendored/in-tree deps

[artifact_groups.third-party-libs]
description = "Optional third-party libraries (for tests/specific features)"
type = "generic"
source_sets = []  # No submodules - uses vendored/in-tree deps

[artifact_groups.base]
description = "Base ROCm infrastructure and CMake tools"
type = "generic"
artifact_group_deps = []
source_sets = ["base"]

[artifact_groups.core-runtime]
description = "Core runtime (ROCR-Runtime, rocminfo)"
type = "generic"
artifact_group_deps = ["base", "third-party-sysdeps"]
source_sets = ["rocm-systems"]

[artifact_groups.compiler]
description = "AMD LLVM toolchain and compiler infrastructure"
type = "generic"
artifact_group_deps = ["third-party-sysdeps"]
source_sets = ["compilers"]

[artifact_groups.hip-runtime]
description = "HIP runtime"
type = "generic"
artifact_group_deps = ["core-runtime", "compiler"]
source_sets = ["rocm-systems"]  # clr is in rocm-systems

[artifact_groups.opencl-runtime]
description = "OpenCL runtime"
type = "generic"
artifact_group_deps = ["core-runtime", "compiler"]
source_sets = ["rocm-systems"]  # clr is in rocm-systems

[artifact_groups.math-libs]
description = "Math libraries (BLAS, FFT, RAND, etc.)"
type = "per-arch"  # Built per GPU architecture
artifact_group_deps = ["hip-runtime", "profiler-core"]
source_sets = ["rocm-libraries"]

[artifact_groups.ml-libs]
description = "Machine learning libraries"
type = "per-arch"
artifact_group_deps = ["math-libs", "profiler-core"]
source_sets = ["rocm-libraries", "ml-frameworks"]

[artifact_groups.comm-libs]
description = "Communication libraries"
type = "per-arch"
artifact_group_deps = ["hip-runtime"]
source_sets = ["comm-libs"]

[artifact_groups.profiler-core]
description = "Core profiling libraries and annotation support"
type = "generic"
artifact_group_deps = ["core-runtime"]
source_sets = ["rocm-systems"]  # rocprofiler-sdk is in rocm-systems

[artifact_groups.dctools-core]
description = "Data center management tools with minimal dependencies"
type = "generic"
artifact_group_deps = ["core-runtime", "profiler-core"]
source_sets = ["base"]  # RDC uses amdsmi from base

# Future artifact groups
# [artifact_groups.dctools-rocm]
# description = "Data center tools that depend on ROCm libraries"
# type = "generic"
# artifact_group_deps = ["math-libs", "ml-libs", "profiler-core"]

[artifact_groups.profiler-apps]
description = "Profiler applications and analysis tools"
type = "generic"
artifact_group_deps = ["profiler-core", "compiler"]
source_sets = ["rocm-systems", "profiler-extras"]  # rocprofiler-systems + trace decoder

# [artifact_groups.iree-libs]
# description = "IREE and Fusilli integration"
# type = "generic"
# artifact_group_deps = ["third-party-sysdeps", "base"]

# ==============================================================================
# ARTIFACTS - The actual build outputs that can be transmitted between stages
# ==============================================================================
# Artifacts are the fundamental packaging units
# Each artifact produces components: dbg, dev, doc, lib, run, test

# --- Third-party Dependencies ---

[artifacts.sysdeps]
artifact_group = "third-party-sysdeps"
type = "target-neutral"
artifact_deps = []  # No dependencies on other artifacts
feature_group = "CORE"  # Part of core, enabled by default

[artifacts.host-blas]
artifact_group = "third-party-libs"
type = "target-neutral"
artifact_deps = []
feature_group = "HOST_MATH"  # Controlled by THEROCK_ENABLE_HOST_MATH (OFF by default)

[artifacts.host-suite-sparse]
artifact_group = "third-party-libs"
type = "target-neutral"
artifact_deps = ["host-blas"]  # SuiteSparse depends on BLAS
feature_name = "HOST_SUITE_SPARSE"
feature_group = "HOST_MATH"  # Controlled by THEROCK_ENABLE_HOST_MATH (OFF by default)
disable_platforms = ["windows"]

[artifacts.fftw3]
artifact_group = "third-party-libs"
type = "target-neutral"
artifact_deps = []
feature_group = "HOST_MATH"  # Controlled by THEROCK_ENABLE_HOST_MATH (OFF by default)

# --- Base Infrastructure ---

[artifacts.base]
artifact_group = "base"
type = "target-neutral"
artifact_deps = []
feature_group = "CORE"  # Part of core, enabled by default

# --- Compiler Artifacts ---

[artifacts.amd-llvm]
artifact_group = "compiler"
type = "target-neutral"
artifact_deps = ["sysdeps"]
feature_name = "COMPILER"
feature_group = "ALL"

[artifacts.hipify]
artifact_group = "compiler"
type = "target-neutral"
artifact_deps = ["amd-llvm"]  # Built on top of amd-llvm
feature_group = "ALL"

# --- Runtime Artifacts ---

[artifacts.core-runtime]
artifact_group = "core-runtime"
type = "target-neutral"
artifact_deps = ["base", "sysdeps", "amd-llvm"]
feature_name = "CORE_RUNTIME"
feature_group = "CORE"
disable_platforms = ["windows"]

[artifacts.core-hip]
artifact_group = "hip-runtime"
type = "target-neutral"
artifact_deps = ["core-runtime", "amd-llvm"]
feature_name = "HIP_RUNTIME"
feature_group = "CORE"  # Part of core, enabled by default

[artifacts.core-ocl]
artifact_group = "opencl-runtime"
type = "target-neutral"
artifact_deps = ["core-runtime", "amd-llvm"]
feature_name = "OCL_RUNTIME"
feature_group = "CORE"  # Part of core, enabled by default

[artifacts.core-hipinfo]
artifact_group = "hip-runtime"
type = "target-neutral"
platform = "windows"
artifact_deps = ["core-hip"]
feature_group = "CORE"  # Part of core, enabled by default

# --- Math Libraries (per-arch) ---

[artifacts.blas]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip", "host-blas", "host-suite-sparse", "rocprofiler-sdk"]

[artifacts.fft]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip", "fftw3", "rocprofiler-sdk"]

[artifacts.rand]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip"]

[artifacts.prim]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip"]

[artifacts.rocwmma]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip"]

[artifacts.support]
artifact_group = "math-libs"
type = "target-specific"
artifact_deps = []

# --- ML Libraries (per-arch) ---

[artifacts.composable-kernel]
artifact_group = "ml-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip"]
disable_platforms = ["windows"]

[artifacts.miopen]
artifact_group = "ml-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip", "blas", "composable-kernel", "rand", "rocprofiler-sdk"]

[artifacts.hipdnn]
artifact_group = "ml-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip"]

[artifacts.miopen-plugin]
artifact_group = "ml-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip", "miopen", "hipdnn"]

# --- Communication Libraries (per-arch) ---

[artifacts.rccl]
artifact_group = "comm-libs"
type = "target-specific"
artifact_deps = ["core-runtime", "core-hip", "rocprofiler-sdk"]
disable_platforms = ["windows"]

# --- Profiler Tools ---

[artifacts.rocprofiler-sdk]
artifact_group = "profiler-core"
type = "target-neutral"
artifact_deps = ["core-runtime", "base"]  # rocprofiler-register is in base
feature_name = "ROCPROFV3"
feature_group = "PROFILER"
disable_platforms = ["windows"]

[artifacts.rocprofiler-compute]
artifact_group = "profiler-core"
type = "target-neutral"
artifact_deps = ["rocprofiler-sdk"]
feature_group = "PROFILER"
disable_platforms = ["windows"]

[artifacts.rocprofiler-systems]
artifact_group = "profiler-apps"
type = "target-neutral"
artifact_deps = ["amd-llvm", "rocprofiler-sdk"]
feature_name = "ROCPROFSYS"
feature_group = "PROFILER"
disable_platforms = ["windows"]

# --- Data Center Tools ---

[artifacts.rdc]
artifact_group = "dctools-core"
type = "target-neutral"
artifact_deps = ["rocprofiler-sdk", "sysdeps"]
feature_group = "DC_TOOLS"  # Part of DC tools, enabled by default via THEROCK_ENABLE_ALL
disable_platforms = ["windows"]

# Future dctools-rocm artifacts will go here
# [artifacts.some-future-tool]
# artifact_group = "dctools-rocm"
# type = "target-neutral"
# artifact_deps = ["blas", "miopen", "rocprofiler-sdk"]
