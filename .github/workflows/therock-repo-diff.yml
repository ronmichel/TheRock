name: TheRock Repository Diff Report

on:
  push:
  workflow_dispatch:
    inputs:
      start_commit:
        description: 'Start Commit SHA or Workflow ID'
        required: true
        type: string
      end_commit:
        description: 'End Commit SHA or Workflow ID'
        required: true
        type: string
      workflow_mode:
        description: 'Use Workflow Mode (extract commits from workflow IDs instead of direct commit comparison)'
        required: false
        type: boolean
        default: false

jobs:
  therock-diff-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run TheRock Repository Diff Analysis
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          cd .github/scripts
          echo "Starting TheRock repository diff analysis..."
          echo "Start: ${{ github.event.inputs.start_commit }}"
          echo "End: ${{ github.event.inputs.end_commit }}"
          echo "Workflow Mode: ${{ github.event.inputs.workflow_mode }}"

          if [ "${{ github.event.inputs.workflow_mode }}" = "true" ]; then
            python3 repo-diff.py \
              --start "${{ github.event.inputs.start_commit }}" \
              --end "${{ github.event.inputs.end_commit }}" \
              --workflow-mode
          else
            python3 repo-diff.py \
              --start "${{ github.event.inputs.start_commit }}" \
              --end "${{ github.event.inputs.end_commit }}"
          fi

      - name: Generate job summary
        if: always()
        run: |
          cd .github/scripts

          echo "## TheRock Repository Diff Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Period:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Start Commit:** \`${{ github.event.inputs.start_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **End Commit:** \`${{ github.event.inputs.end_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Mode:** ${{ github.event.inputs.workflow_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "TheRockReport.html" ]; then
            echo "**Report Generated Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The detailed HTML report has been uploaded as an artifact and can be downloaded from the workflow run." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Report Generation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No HTML report was generated. Check the logs for errors." >> $GITHUB_STEP_SUMMARY
          fi

      - name: List generated files
        run: |
          cd .github/scripts
          echo "Files generated:"
          ls -la *.html || echo "No HTML files found"

      - name: Upload TheRock HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: therock-diff-report
          path: .github/scripts/TheRockReport.html
          retention-days: 30
        if: always()

