name: TheRock Repository Diff Report

on:
  push:
    branches:
      - 'amd/hsivasun/submodule-reports'
  workflow_dispatch:
    inputs:
      start_commit:
        description: 'Start Commit SHA or Workflow ID'
        required: true
        type: string
      end_commit:
        description: 'End Commit SHA or Workflow ID'
        required: true
        type: string
      workflow_mode:
        description: 'Use Workflow Mode (extract commits from workflow IDs instead of direct commit comparison)'
        required: false
        type: boolean
        default: false

jobs:
  therock-diff-report:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set commit parameters
        id: commits
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Use your test commits when triggered by push
            echo "start_commit=0ae0df6719a6e2096d221d6a61326d8494fa050b" >> $GITHUB_OUTPUT
            echo "end_commit=c834dd20feb0d7228c8a4af4790bb8ed54d8a26c" >> $GITHUB_OUTPUT
            echo "workflow_mode=false" >> $GITHUB_OUTPUT
            echo "Using default test commits for push trigger"
          else
            # Use inputs when triggered manually
            echo "start_commit=${{ github.event.inputs.start_commit }}" >> $GITHUB_OUTPUT
            echo "end_commit=${{ github.event.inputs.end_commit }}" >> $GITHUB_OUTPUT
            echo "workflow_mode=${{ github.event.inputs.workflow_mode }}" >> $GITHUB_OUTPUT
            echo "Using manual inputs for workflow_dispatch"
          fi

      - name: Run TheRock Repository Diff Analysis
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          cd build_tools/github_actions
          echo "Starting TheRock repository diff analysis..."
          echo "Start: ${{ steps.commits.outputs.start_commit }}"
          echo "End: ${{ steps.commits.outputs.end_commit }}"
          echo "Workflow Mode: ${{ steps.commits.outputs.workflow_mode }}"

          if [ "${{ steps.commits.outputs.workflow_mode }}" = "true" ]; then
            python3 repo-diff.py \
              --start "${{ steps.commits.outputs.start_commit }}" \
              --end "${{ steps.commits.outputs.end_commit }}" \
              --workflow-mode
          else
            python3 repo-diff.py \
              --start "${{ steps.commits.outputs.start_commit }}" \
              --end "${{ steps.commits.outputs.end_commit }}"
          fi

      - name: Upload TheRock HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: therock-diff-report
          path: build_tools/github_actions/TheRockReport.html
          retention-days: 15
        if: always()

