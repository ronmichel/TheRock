# Multi-Arch CI - Sharded Pipeline
#
# This workflow implements a multi-stage build pipeline where:
# - Generic stages (foundation, compiler-runtime) build ONCE for all architectures
# - Per-arch stages (math-libs, comm-libs) run in PARALLEL per GPU family
#
# Stage dependency graph:
#   foundation (generic)
#       |
#   compiler-runtime (generic)
#       |
#   +---+---+---+---+
#   |   |   |   |   |
#  math comm prof dc  (parallel, math/comm are per-arch)
#
# Artifacts flow between stages via S3, keyed by run_id.

name: Multi-Arch CI

on:
  workflow_dispatch:
    inputs:
      linux_amdgpu_families:
        type: string
        description: "Comma-separated list of Linux GPU families (e.g., gfx94X-dcgpu,gfx110X-all)"
        default: "gfx94X-dcgpu,gfx110X-all"
      build_variant:
        type: string
        description: "Build variant (release, asan)"
        default: "release"
      package_version:
        type: string
        description: "Package version string"
        default: "ADHOCBUILD"
      stages:
        type: string
        description: "Comma-separated list of stages to build (empty = all). Options: foundation, compiler-runtime, math-libs, comm-libs, dctools-core, profiler-apps"
        default: ""
      skip_tests:
        type: boolean
        description: "Skip test jobs"
        default: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------------
  # Setup job - compute configuration
  # --------------------------------------------------------------------------
  setup:
    name: Setup
    runs-on: ubuntu-24.04
    outputs:
      amdgpu_families_json: ${{ steps.configure.outputs.amdgpu_families_json }}
      enabled_stages: ${{ steps.configure.outputs.enabled_stages }}
      artifact_group: ${{ steps.configure.outputs.artifact_group }}
      rocm_package_version: ${{ steps.version.outputs.rocm_package_version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Configure pipeline
        id: configure
        run: |
          python ./build_tools/github_actions/configure_multi_arch_ci.py \
            --amdgpu-families "${{ inputs.linux_amdgpu_families }}" \
            --stages "${{ inputs.stages }}" \
            --build-variant "${{ inputs.build_variant }}"

      - name: Compute package version
        id: version
        run: |
          python ./build_tools/compute_rocm_package_version.py --release-type=dev

  # --------------------------------------------------------------------------
  # Linux Build - Sharded Pipeline
  # --------------------------------------------------------------------------
  linux_build:
    name: Linux Build (${{ inputs.build_variant }})
    needs: setup
    uses: ./.github/workflows/multi_arch_build_portable_linux.yml
    secrets: inherit
    with:
      amdgpu_families_json: ${{ needs.setup.outputs.amdgpu_families_json }}
      artifact_group: ${{ needs.setup.outputs.artifact_group }}
      build_variant: ${{ inputs.build_variant }}
      package_version: ${{ needs.setup.outputs.rocm_package_version }}
      enabled_stages: ${{ needs.setup.outputs.enabled_stages }}
    permissions:
      contents: read
      id-token: write

  # --------------------------------------------------------------------------
  # Summary
  # --------------------------------------------------------------------------
  multi_arch_ci_summary:
    name: Multi-Arch CI Summary
    if: always()
    needs:
      - setup
      - linux_build
    runs-on: ubuntu-24.04
    steps:
      - name: Output results
        run: |
          echo "## Multi-Arch CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Variant**: ${{ inputs.build_variant }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GPU Families**: ${{ inputs.linux_amdgpu_families }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stages**: ${{ needs.setup.outputs.enabled_stages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo '${{ toJson(needs) }}'

          FAILED_JOBS="$(echo '${{ toJson(needs) }}' \
            | jq --raw-output '
              to_entries
              | map(select(.value.result != "success" and .value.result != "skipped"))
              | map(.key)
              | join(",")
            ' \
          )"

          if [[ -n "${FAILED_JOBS}" ]]; then
            echo "The following jobs failed: ${FAILED_JOBS}"
            exit 1
          else
            echo "All jobs succeeded."
          fi
