name: Test Linux JAX Wheels

on:
  workflow_call:
    inputs:
      amdgpu_family:
        required: true
        type: string
      release_type:
        required: true
        type: string
      s3_subdir:
        required: true
        type: string
      package_index_url:
        description: Base CloudFront URL for the Python package index
        required: true
        type: string
      rocm_version:
        description: ROCm version (optional, informational)
        required: false
        type: string
      tar_url:
        description: URL to TheRock tarball to configure ROCm
        required: true
        type: string
      python_versions:
        description: Python version(s) to test (e.g., "3.12")
        required: true
        type: string
      jax_ref:
        description: rocm-jax repository ref/branch to check out
        required: false
        type: string
        default: rocm-jaxlib-v0.8.0
      ref:
        description: "Branch, tag or SHA to checkout. Defaults to the reference or SHA that triggered the workflow."
        type: string

  workflow_dispatch:
    inputs:
      amdgpu_family:
        type: choice
        options:
          - gfx110X-dgpu
          - gfx1151
          - gfx120X-all
          - gfx94X-dcgpu
          - gfx950-dcgpu
        default: gfx94X-dcgpu
      release_type:
        description: The type of release ("nightly" or "dev")
        required: true
        type: string
        default: dev
      s3_subdir:
        description: S3 subdirectory, not including the GPU-family
        required: true
        type: string
        default: v2
      package_index_url:
        description: Base CloudFront URL for the Python package index
        required: true
        type: string
        default: https://rocm.nightlies.amd.com/v2-staging/
      rocm_version:
        description: ROCm version
        required: false
        type: string
      tar_url:
        description: URL to TheRock tarball to configure ROCm
        required: true
        type: string
      python_versions:
        description: Python version(s) to test (e.g., "3.12")
        required: true
        type: string
        default: "3.12"
      jax_ref:
        description: rocm-jax repository ref/branch to check out
        required: false
        type: string
        default: rocm-jaxlib-v0.8.0

permissions:
  contents: read
  packages: read

jobs:
  test_jax_wheels:
    name: Test JAX Wheels | ${{ inputs.amdgpu_family }} | Python ${{ inputs.python_versions }}
    runs-on: linux-mi325-1gpu-ossci-rocm-test
    container:
      image: ghcr.io/rocm/no_rocm_image_ubuntu24_04@sha256:405945a40deaff9db90b9839c0f41d4cba4a383c1a7459b28627047bf6302a26
      options:  >-
          --device /dev/kfd
          --device /dev/dri
          --group-add render
          --group-add video
          --user root

    env:
      VIRTUAL_ENV: ${{ github.workspace }}/.venv
      PIP_PROGRESS_BAR: off
      PIP_DISABLE_PIP_VERSION_CHECK: 1
      THEROCK_TAR_URL: ${{ inputs.tar_url }}
      PYTHON_VERSION: ${{ inputs.python_versions }}
      WHEEL_INDEX_URL: ${{ inputs.package_index_url }}/${{ inputs.amdgpu_family }}

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          repository: ${{ inputs.repository || github.repository }}
          ref: ${{ inputs.ref || '' }}

      - name: Checkout rocm-jax (plugin + build scripts)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: jax
          repository: rocm/rocm-jax
          ref: ${{ inputs.jax_ref }}

      - name: Checkout JAX tests repo (for extended tests)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: rocm/jax
          ref: ${{ inputs.jax_ref }}
          path: jax/jax_tests

      - name: System deps, venv configure
        shell: bash
        run: |
           apt-get update && apt-get install -y --no-install-recommends python${{ inputs.python_versions }}-venv python3-pip ca-certificates git
           python3 -m venv "${VIRTUAL_ENV}"
           echo "PATH=${VIRTUAL_ENV}/bin:${PATH}" >> "$GITHUB_ENV"
           "${VIRTUAL_ENV}/bin/python" -m pip install --upgrade pip setuptools wheel
           python3 build_tools/setup_venv.py "${VIRTUAL_ENV}" --activate-in-future-github-actions-steps

      - name: Install base JAX test requirements
        shell: bash
        run: |
          # This script sets up the venv and activates it across steps; keep it consistent
          pip install -r external-builds/jax/requirements-jax.txt

      - name: Configure ROCm from TheRock tarball
        run: |
          python build_tools/install_rocm_tar.py "${{ inputs.tar_url }}" "${{ inputs.rocm_version }}"

      - name: Extract JAX version and set to GITHUB_ENV
        run: |
          # Extract JAX version from requirements.txt (e.g., "jax==0.8.0")
          JAX_VERSION=$(tr -d ' ' < jax/build/requirements.txt \
          | grep -E '^(jax|jaxlib)==[^#]+' | head -n1 | cut -d'=' -f3)
          echo "JAX_VERSION=$JAX_VERSION" >> "$GITHUB_ENV"

      - name: Install JAX wheels from package index
        run: |
          # Install jaxlib/plugin/pjrt from the GPU-family index; install jax from PyPI to match the version
          pip install --index-url "${{ env.WHEEL_INDEX_URL }}" \
            "jaxlib==${JAX_VERSION}+rocm${{ inputs.rocm_version }}" \
            "jax-rocm7-plugin==${JAX_VERSION}+rocm${{ inputs.rocm_version }}" \
            "jax-rocm7-pjrt==${JAX_VERSION}+rocm${{ inputs.rocm_version }}"
          pip install --extra-index-url https://pypi.org/simple "jax==${JAX_VERSION}"

      - name: Run JAX tests
        run: |
          pytest jax/jax_tests/tests/multi_device_test.py -q
          pytest jax/jax_tests/tests/core_test.py -q
          pytest jax/jax_tests/tests/util_test.py -q
          pytest jax/jax_tests/tests/scipy_stats_test.py -q
